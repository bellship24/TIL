**목차**

- [1. 요약](#1-요약)
- [path operation function 에 쿼리 파라미터 대신 db 인스턴스를 인자로 받기](#path-operation-function-에-쿼리-파라미터-대신-db-인스턴스를-인자로-받기)
  - [`main.py` 수정](#mainpy-수정)
    - [필요 패키지 임포트](#필요-패키지-임포트)
    - [get_db 함수 생성](#get_db-함수-생성)
    - [인자 추가](#인자-추가)
  - [스웨거 리프래시 및 확인](#스웨거-리프래시-및-확인)
- [db 인스턴스에 데이터 업데이트 후 리턴 받기](#db-인스턴스에-데이터-업데이트-후-리턴-받기)
  - [`main.py` 수정](#mainpy-수정-1)
  - [스웨거에서 테스트](#스웨거에서-테스트)
  - [데이터베이스 서버에서 확인 (TablePlus)](#데이터베이스-서버에서-확인-tableplus)

**참고**

- [[Youtube] Store blog to database](https://youtu.be/7t2alSnE2-I?t=5616)

---

# 1. 요약

- 이제, path opration function 에 쿼리 파라미터가 아닌 앞서 본 데이터베이스 인스턴스를 넣어 사용해보자.
- db 인자의 타입을 sqlalchemy 의 session 으로 설정하고 fastapi.Depends 함수를 사용해 default 값을 설정해주면 된다. 또한, 전달 받은 request 를 적절한 model 로 말아 json 을 만들고 리턴하며 db 인자를 활용해 데이터베이스 서버에 데이터를 추가하면 된다.
- 다시 말해, Session 은 sqlalchemy.orm 의 부분이다. 이런 db 인자의 Session 이라는 기본값은 get_db 에 의존한다. 이로 인해, 우리는 db 인스턴스를 얻을 수 있다. 그리고 new_blog 는 우리가 앞서 정의한 model 로써 결국, 데이터베이스에 전달하기 위한 구조이다. 그래서 이런 new_blog 를 add 하고 commit 하며 refresh 하여 가져오고 결국, return 하는 소스코드이다.

# path operation function 에 쿼리 파라미터 대신 db 인스턴스를 인자로 받기

## `main.py` 수정

### 필요 패키지 임포트

``` py
from fastapi import Depends
from sqlalchemy.orm import Session
from database import SessionLocal
```

- fastapi 로부터 Depends 를 임포트한다. 이는 Session 의 default 값을 설정하기 위함이다.
- sqlalchemy.orm 으로부터 Session 을 임포트한다.
- `database.py` 로부터 SessionLocal 을 임포트한다.

### get_db 함수 생성

``` py
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 인자 추가

``` py
@app.post('/blog')
def create(request: schemas.Blog, db: Session = Depends(get_db)):
    return db
```

- `blog` 경로에 대한 path operation function 의 인자에 `db` 를 `db: Session = Depends(get_db)` 로 입력한다.

## 스웨거 리프래시 및 확인

![](/.uploads2/2021-10-01-03-10-50.png)

- 이제, db 파라미터를 더 이상 쿼리 파라미터로 보지 않는다.

# db 인스턴스에 데이터 업데이트 후 리턴 받기

- 이제, POST 호출로 전달 받은 데이터를 db 인스턴스에 넣고 response body 에 넣어보자.

## `main.py` 수정

``` py
@app.post('/blog')
def create(request: schemas.Blog, db: Session = Depends(get_db)):
    new_blog = models.Blog(title=request.title, body=request.body)
    db.add(new_blog)
    db.commit()
    db.refresh(new_blog)
    return new_blog
```

## 스웨거에서 테스트

![](/.uploads2/2021-10-01-03-17-55.png)

- request body 에 데이터를 담아 보내보자.

![](/.uploads2/2021-10-01-03-18-13.png)

- response body 에 new_blog 가 정상적으로 출력된 것을 확인할 수 있다.

## 데이터베이스 서버에서 확인 (TablePlus)

![](/.uploads2/2021-10-01-03-19-41.png)

- dbms 에서 확인해도 데이터가 정상적으로 들어간 것을 확인할 수 있다.
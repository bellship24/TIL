**ëª©ì°¨**

- [1. ìš”ì•½](#1-ìš”ì•½)
- [2. CI ì—ì„œ docker build í•  ë•Œ, dockerfile ì—ì„œ gitlab predefined variable ì‚¬ìš©í•˜ëŠ” ë°©ë²•](#2-ci-ì—ì„œ-docker-build-í• -ë•Œ-dockerfile-ì—ì„œ-gitlab-predefined-variable-ì‚¬ìš©í•˜ëŠ”-ë°©ë²•)
  - [2.1. í˜„ìƒ](#21-í˜„ìƒ)
  - [2.2. ë¶„ì„](#22-ë¶„ì„)
  - [2.3. í•´ê²°](#23-í•´ê²°)
  - [2.4. ê¸°íƒ€](#24-ê¸°íƒ€)
    - [2.4.1. ì‹¤íŒ¨í•œ í•´ê²° `--build-arg` ë°©ë²•](#241-ì‹¤íŒ¨í•œ-í•´ê²°---build-arg-ë°©ë²•)
- [3. runner ê°€ image pulling ì´ ì•ˆë˜ëŠ” ì´ìŠˆ](#3-runner-ê°€-image-pulling-ì´-ì•ˆë˜ëŠ”-ì´ìŠˆ)
  - [3.1. í˜„ìƒ](#31-í˜„ìƒ)
  - [3.2. ë¶„ì„](#32-ë¶„ì„)
  - [3.3. í•´ê²°](#33-í•´ê²°)
    - [3.3.1. (o) ì¸í„°ë„· ì—°ê²° í™•ì¸í•  ê²ƒ](#331-o-ì¸í„°ë„·-ì—°ê²°-í™•ì¸í• -ê²ƒ)
- [4. docker executor ì—ì„œ CI ë¹Œë“œ ì‹œì— self-signed ì—ëŸ¬](#4-docker-executor-ì—ì„œ-ci-ë¹Œë“œ-ì‹œì—-self-signed-ì—ëŸ¬)
  - [4.1. í˜„ìƒ](#41-í˜„ìƒ)
  - [4.2. ë¶„ì„](#42-ë¶„ì„)
  - [4.3. í•´ê²°](#43-í•´ê²°)
    - [config.toml ì— pre_clone_script ì„¤ì •](#configtoml-ì—-pre_clone_script-ì„¤ì •)
    - [4.3.1. (â–³) docker network ë¥¼ host ë¡œ ì„¤ì •](#431--docker-network-ë¥¼-host-ë¡œ-ì„¤ì •)

**ì°¸ê³ **

---

# 1. ìš”ì•½

> gitlab-runner ë¥¼ ì‚¬ìš©í•˜ë©´ì„œ ìƒê¸´ ì´ìŠˆë“¤ì— ëŒ€í•œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë‚´ìš©ì„ ì •ë¦¬í–ˆë‹¤. ëŒ€ì²´ë¡œ `í˜„ìƒ -> ë¶„ì„ -> í•´ê²°` ìˆœìœ¼ë¡œ ì§„í–‰í–ˆë‹¤.

# 2. CI ì—ì„œ docker build í•  ë•Œ, dockerfile ì—ì„œ gitlab predefined variable ì‚¬ìš©í•˜ëŠ” ë°©ë²•

## 2.1. í˜„ìƒ

`Dockerfile`

``` dockerfile
FROM $CI_REGISTRY_IMAGE:$CI_COMMIT_BEFORE_SHA
...
```

`.gitlab-ci.yml`

``` bash
...
build:
  stage: build
  services:
  - name: docker:19.03.13-dind
    command: ["--insecure-registry=registry.mylab.com"]
  script:
  - >
    docker build .
    --cache-from $CI_REGISTRY_IMAGE:latest
    --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
...
```

- ìœ„ì— dockerfile ì˜ ì˜ë„ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤. base image ì´ë¦„ì— gitlab predefined variable ì¸ `$CI_REGISTRY_IMAGE` ì™€ `$CI_COMMIT_BEFORE_SHA` ë¥¼ ë„£ì–´ í•´ë‹¹ CI git repo. ì— ëŒ€í•œ gitlab registry ì•ˆì— ì´ë¯¸ì§€ ì´ë¦„ê³¼ ì´ì „ ì»¤ë°‹ SHA ë¡œ ì •ì˜ëœ tag ë¥¼ ì‚¬ìš©í•˜ì—¬ í¸ë¦¬ì„±ì„ ë†’ì˜€ë‹¤.
- .gitlab-ci.yml ì—ì„œë„ ë¹Œë“œí•œ ë„ì»¤ ì´ë¯¸ì§€ì˜ tag ë¥¼ `$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA` ë¡œì¨ ì´ ì—­ì‹œë„ gitlab redefined variable ì„ ì‚¬ìš©í•˜ì—¬ í¸ë¦¬ì„±ì„ ë†’ì˜€ë‹¤.
- í•˜ì§€ë§Œ, CI íŒŒì´í”„ë¼ì¸ì„ ëŒë ¸ì„ ë•Œ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ì¶œë ¥ëœë‹¤.

``` bash
...
[32;1m$ docker build . --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA[0;m
Sending build context to Docker daemon  226.6MB

Step 1/4 : FROM $CI_REGISTRY_IMAGE:$CI_COMMIT_BEFORE_SHA
invalid reference format
section_end:1627233650:step_script
[0Ksection_start:1627233650:after_script
[0K[0K[36;1mRunning after_script[0;m
[0;m[32;1mRunning after script...[0;m
[32;1m$ docker logout[0;m
Removing login credentials for https://index.docker.io/v1/
section_end:1627233650:after_script
[0Ksection_start:1627233650:cleanup_file_variables
[0K[0K[36;1mCleaning up file based variables[0;m
[0;msection_end:1627233650:cleanup_file_variables
[0K[31;1mERROR: Job failed: command terminated with exit code 1
[0;m
```

## 2.2. ë¶„ì„

- gitlab runner ì˜ predefined variable ì€ bash ì—ì„œ ì˜ ì¡°íšŒë˜ì§€ë§Œ dockerfile ì•ˆì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤. ì¦‰, dockerfile ì²«ë²ˆì§¸ ì¤„ì¸ `FROM $CI_REGISTRY_IMAGE:$CI_COMMIT_BEFORE_SHA` ì—ì„œ ê° ë³€ìˆ˜ë“¤ì€ ì •ì˜ë˜ì–´ ìˆì§€ ì•Šì€ ìƒíƒœë¡œ ë³´ì¸ë‹¤.

## 2.3. í•´ê²°

- `docker build` í•  ë•Œ, `--build-arg` ë¥¼ í†µí•´ `ARG` ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë©´, ì•„ë˜ì™€ ê°™ì´ `.gitlab-ci.yml` ì´ ì™„ì„±ëœë‹¤.
- ì—¬ê¸°ì„œëŠ” `$CI_REGISTRY_TAG` ì— ëŒ€í•´ ì´ì „ ì»¤ë°‹ SHA ë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©ë„ ê°€ëŠ¥í•˜ë‹¤. ì´ ë¶€ë¶„ì€ ì£¼ì„ ì²˜ë¦¬ í–ˆë‹¤. ì¦‰, ì£¼ì„ ì²˜ë¦¬ë¥¼ í•˜ë©´ dockerfile ì˜ ARG ë¥¼ ë”°ë¥´ê³  --build-arg ë¥¼ ì“°ë©´ ARG ë¥¼ override í•  ìˆ˜ ìˆë‹¤.

``` yaml
...
build:
  stage: build
  services:
  - name: docker:19.03.13-dind
    command: ["--insecure-registry=registry.mylab.com"]
  script:
  - >
    docker build .
    --cache-from $CI_REGISTRY_IMAGE:latest
    --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    --build-arg CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE
  # --build-arg CI_REGISTRY_TAG=$CI_COMMIT_BEFORE_SHA
...
```

- ë‹¨, ë®ì–´ì“¸ `ARG` ë¥¼ ê¼­ ëª…ì‹œí•´ì¤˜ì•¼ í•œë‹¤. ê·¸ëŸ¬ë©´, ì•„ë˜ì™€ ê°™ì´ `Dockerfile` ì´ ì™„ì„±ëœë‹¤.

``` dockerfile
ARG CI_REGISTRY_IMAGE=pytorch/torchserve:latest
ARG CI_REGISTRY_TAG=base

FROM $CI_REGISTRY_IMAGE:$CI_REGISTRY_TAG

COPY mytorch/ /home/model-server/mydata/

WORKDIR /home/model-server/mydata

RUN torch-model-archiver \
  --model-name densenet161 \
  --version 1.0 \
  --model-file model.py \
  --serialized-file densenet161-8d451a50.pth \
  --export-path  /home/model-server/model-store \
  --extra-files index_to_name.json \
  --handler image_classifier 
```

- ì´ì œ, git repo. ë¥¼ ì»¤ë°‹í•´ì„œ ì‹¤í–‰ë˜ëŠ” íŒŒì´í”„ë¼ì¸ì˜ ë¡œê·¸ëŠ” ì•„ë˜ì™€ ê°™ì´ dockerfile ì—ì„œ gitlab predefined variable ì„ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš©í–ˆë‹¤.

``` bash
[32;1m$ docker images[0;m
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
[32;1m$ docker build . --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --build-arg CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE[0;m
Sending build context to Docker daemon  226.6MB

Step 1/6 : ARG CI_REGISTRY_IMAGE=pytorch/torchserve:latest
Step 2/6 : ARG CI_REGISTRY_TAG=base
Step 3/6 : FROM $CI_REGISTRY_IMAGE:$CI_REGISTRY_TAG
base: Pulling from root/mycicd
e7ae86ffe2df: Pulling fs layer
0b2fe2118c34: Pulling fs layer
2bea50abcc80: Pulling fs layer
910e6e0ca555: Pulling fs layer
a3d6a01785b9: Pulling fs layer
4f4fb700ef54: Pulling fs layer
910e6e0ca555: Waiting
a3d6a01785b9: Waiting
4f4fb700ef54: Waiting
2bea50abcc80: Verifying Checksum
2bea50abcc80: Download complete
910e6e0ca555: Verifying Checksum
910e6e0ca555: Download complete
e7ae86ffe2df: Verifying Checksum
e7ae86ffe2df: Download complete
4f4fb700ef54: Verifying Checksum
4f4fb700ef54: Download complete
e7ae86ffe2df: Pull complete
0b2fe2118c34: Verifying Checksum
0b2fe2118c34: Download complete
a3d6a01785b9: Download complete
0b2fe2118c34: Pull complete
2bea50abcc80: Pull complete
910e6e0ca555: Pull complete
a3d6a01785b9: Pull complete
4f4fb700ef54: Pull complete
Digest: sha256:1793abc1987d246842e6e4c428ac66ff00ed2d018943132fbe4bb1870f5b3590
Status: Downloaded newer image for registry.mylab.com/root/mycicd:base
 ---> aafcbaecf9ea
Step 4/6 : COPY mytorch/ /home/model-server/mydata/
 ---> 8018d1083594
Step 5/6 : WORKDIR /home/model-server/mydata
 ---> Running in 9f25d4d469d1
Removing intermediate container 9f25d4d469d1
 ---> 0cf99a4ba419
Step 6/6 : RUN torch-model-archiver   --model-name densenet161   --version 1.0   --model-file model.py   --serialized-file densenet161-8d451a50.pth   --export-path  /home/model-server/model-store   --extra-files index_to_name.json   --handler image_classifier
 ---> Running in 6bcad0f00196
Removing intermediate container 6bcad0f00196
 ---> 2401d18fcf42
Successfully built 2401d18fcf42
Successfully tagged registry.mylab.com/root/mycicd:4100a213805e5b40dd9356ba3d92e95790ef381e
[32;1m$ docker images[0;m
REPOSITORY                       TAG                                        IMAGE ID            CREATED             SIZE
registry.mylab.com/root/mycicd   4100a213805e5b40dd9356ba3d92e95790ef381e   2401d18fcf42        1 second ago        3.2GB
registry.mylab.com/root/mycicd   base                                       aafcbaecf9ea        3 days ago          2.86GB
```

- ìœ„ì— ë³´ë©´ `dockerfile` ì— ë”°ë¼ Step 1/6 ì—ì„œ `pytorch/torchserve:latest` ë¥¼ ì“°ëŠ” ê²ƒ ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ ì‹¤ì œë¡œëŠ” base ì´ë¯¸ì§€ê°€ `.gitlab-ci.yml` ì—ì„œ `docker build` ëª…ë ¹ì–´ ë¶€ë¶„ì—ì„œ `--build-arg` ë¡œ ëª…ì‹œí•œ `CI_REGISTRY_IMAGE` ë¥¼ ì“´ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

## 2.4. ê¸°íƒ€

### 2.4.1. ì‹¤íŒ¨í•œ í•´ê²° `--build-arg` ë°©ë²•

- dockerfile ì•ˆì—ì„œ bash ì˜ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì¸ì‹ ëª»í•˜ê¸° ë•Œë¬¸ì— `docker build` ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•  ë•Œ `--build-arg` ë¡œ í•´ë‹¹ ë³€ìˆ˜ë¥¼ í™˜ê²½ ë³€ìˆ˜ì—ì„œ dockerfile ì•ˆì— ë³€ìˆ˜ë¡œ ì „ë‹¬í•´ì£¼ë©´ í•´ê²°ë  ê²ƒìœ¼ë¡œ ìƒê°í–ˆë‹¤.
- ê·¸ë˜ì„œ dockerfile ì€ ì•„ë˜ì™€ ê°™ì´ ê·¸ëŒ€ë¡œì´ë‹¤.

``` dockerfile
FROM $CI_REGISTRY_IMAGE:$CI_COMMIT_BEFORE_SHA
...
```

- .gitlab-ci.yml ì—ëŠ” docker build ë¶€ë¶„ì— `--build-arg` ë¥¼ ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€í–ˆë‹¤.

``` yaml
...
build:
  stage: build
  services:
  - name: docker:19.03.13-dind
    command: ["--insecure-registry=registry.mylab.com"]
  script:
  - >
    docker build .
    --cache-from $CI_REGISTRY_IMAGE:latest
    --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    --build-arg CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE
    --build-arg CI_COMMIT_BEFORE_SHA=$CI_COMMIT_BEFORE_SHA
...
```

- í•˜ì§€ë§Œ, ì•„ë˜ì™€ ê°™ì´ ì—ëŸ¬ ë¡œê·¸ê°€ ë°œìƒí–ˆê³  `--build-arg` ë§Œ ì‚¬ìš©í•´ì„œëŠ” íš¨ê³¼ê°€ ì—†ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.

``` bash
...
[32;1m$ docker build . --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --build-arg CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE --build-arg CI_COMMIT_BEFORE_SHA=$CI_COMMIT_BEFORE_SHA[0;m
Sending build context to Docker daemon  226.6MB

Step 1/4 : FROM $CI_REGISTRY_IMAGE:$CI_COMMIT_BEFORE_SHA
invalid reference format
section_end:1627233952:step_script
[0Ksection_start:1627233952:after_script
[0K[0K[36;1mRunning after_script[0;m
[0;m[32;1mRunning after script...[0;m
[32;1m$ docker logout[0;m
Removing login credentials for https://index.docker.io/v1/
section_end:1627233953:after_script
[0Ksection_start:1627233953:cleanup_file_variables
[0K[0K[36;1mCleaning up file based variables[0;m
[0;msection_end:1627233953:cleanup_file_variables
[0K[31;1mERROR: Job failed: command terminated with exit code 1
[0;m
```

# 3. runner ê°€ image pulling ì´ ì•ˆë˜ëŠ” ì´ìŠˆ

## 3.1. í˜„ìƒ

`.gitlab-ci.yml`

``` yml
###
default:
  image: busybox:latest #docker:19.03.13
###

build-job:
  stage: build
  script:
  - echo "Hello, $GITLAB_USER_LOGIN!"

test-job1:
  stage: test
  script:
  - echo "This job tests something"

test-job2:
  stage: test
  script:
  - echo "This job tests something, but takes more time than test-job1."
  - echo "After the echo commands complete, it runs the sleep command for 20 seconds"
  - echo "which simulates a test that runs 20 seconds longer than test-job1"
  - sleep 20

deploy-prod:
  stage: deploy
  script:
  - echo "This job deploys something from the $CI_COMMIT_BRANCH branch."
```

gitlab runner UI ì—ëŸ¬ ë¡œê·¸

![](/.uploads2/2021-09-13-15-41-01.png)

``` bash
[0KRunning with gitlab-runner 14.2.0 (58ba2b95)[0;m
[0K  on gitlab-runner-shared-gitlab-runner-787c99dc89-mfgh6 bJxD1Uqh[0;m
section_start:1631514980:prepare_executor
[0K[0K[36;1mPreparing the "kubernetes" executor[0;m[0;m
[0KUsing Kubernetes namespace: cicd[0;m
[0KUsing Kubernetes executor with image busybox:latest ...[0;m
[0KUsing attach strategy to execute scripts...[0;m
section_end:1631514980:prepare_executor
[0Ksection_start:1631514980:prepare_script
[0K[0K[36;1mPreparing environment[0;m[0;m
Waiting for pod cicd/runner-bjxd1uqh-project-2-concurrent-0sjgmt to be running, status is Pending
Waiting for pod cicd/runner-bjxd1uqh-project-2-concurrent-0sjgmt to be running, status is Pending
	ContainersNotReady: "containers with unready status: [build helper]"
	ContainersNotReady: "containers with unready status: [build helper]"
Waiting for pod cicd/runner-bjxd1uqh-project-2-concurrent-0sjgmt to be running, status is Pending
	ContainersNotReady: "containers with unready status: [build helper]"
	ContainersNotReady: "containers with unready status: [build helper]"
Waiting for pod cicd/runner-bjxd1uqh-project-2-concurrent-0sjgmt to be running, status is Pending
	ContainersNotReady: "containers with unready status: [build helper]"
	ContainersNotReady: "containers with unready status: [build helper]"
Waiting for pod cicd/runner-bjxd1uqh-project-2-concurrent-0sjgmt to be running, status is Pending
	ContainersNotReady: "containers with unready status: [build helper]"
	ContainersNotReady: "containers with unready status: [build helper]"
Waiting for pod cicd/runner-bjxd1uqh-project-2-concurrent-0sjgmt to be running, status is Pending
	ContainersNotReady: "containers with unready status: [build helper]"
	ContainersNotReady: "containers with unready status: [build helper]"
Waiting for pod cicd/runner-bjxd1uqh-project-2-concurrent-0sjgmt to be running, status is Pending
	ContainersNotReady: "containers with unready status: [build helper]"
	ContainersNotReady: "containers with unready status: [build helper]"
[0;33mWARNING: Failed to pull image with policy "": image pull failed: Back-off pulling image "busybox:latest"[0;m
section_end:1631515001:prepare_script
[0K[31;1mERROR: Job failed: prepare environment: waiting for pod running: pulling image "busybox:latest": image pull failed: Back-off pulling image "busybox:latest". Check https://docs.gitlab.com/runner/shells/index.html#shell-profile-loading for more information[0;m
```

## 3.2. ë¶„ì„

ì—ëŸ¬ ë¡œê·¸ ë¶„ì„

- busybox ì´ë¯¸ì§€ë¥¼ pull í•´ì™€ì„œ íŒŒë“œì— ì´ë¯¸ì§€ë¡œ ì‚¬ìš©í•´ ì‘ì—…ì„ ì§„í–‰í•˜ëŠ” í…ŒìŠ¤íŠ¸ ë‚´ìš©ì´ë‹¤.
- ê·¸ëŸ°ë°, ì´ë¯¸ì§€ pull ì´ ì•ˆë˜ëŠ” ìƒí™©ì´ë‹¤.

ë…¸ë“œì—ì„œ ì´ë¯¸ì§€ pull ì‹œë„ ì‹œì— ì—ëŸ¬ ë°œìƒ

``` bash
$ docker pull busybox:latest
Error response from daemon: Get "https://registry-1.docker.io/v2/": dial tcp 107.23.149.57:443: i/o timeout
```

- docker ì˜ registry ì— 443 timeout ì´ ë°œìƒí•œë‹¤.

## 3.3. í•´ê²°

### 3.3.1. (o) ì¸í„°ë„· ì—°ê²° í™•ì¸í•  ê²ƒ

google ë¡œ ping, resolve, 80, 443 í…ŒìŠ¤íŠ¸

``` bash
$ ping google.com
PING google.com (142.250.204.46) 56(84) bytes of data.
64 bytes from hkg07s38-in-f14.1e100.net (142.250.204.46): icmp_seq=1 ttl=109 time=62.6 ms
64 bytes from hkg07s38-in-f14.1e100.net (142.250.204.46): icmp_seq=2 ttl=109 time=58.1 ms
64 bytes from hkg07s38-in-f14.1e100.net (142.250.204.46): icmp_seq=3 ttl=109 time=57.8 ms
^C
--- google.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2002ms
rtt min/avg/max/mdev = 57.839/59.547/62.698/2.239 ms

$ nc -v 142.250.204.46 80 -w 10
nc: connect to 142.250.204.46 port 80 (tcp) timed out: Operation now in progress

$ nc -v 142.250.204.46 443 -w 10
nc: connect to 142.250.204.46 port 443 (tcp) timed out: Operation now in progress
```

- 80, 443 íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ë³´ì•„ ì¸í„°ë„·ì´ ì—°ê²° ì•ˆ ëì„ ìˆ˜ ìˆë‹¤.
- í™•ì¸ í•´ë³´ë‹ˆ ì‚¬ë‚´ ë°©í™”ë²½ ì²˜ë¦¬ê°€ ì•„ì§ ì•ˆ ë˜ì–´ ì¸í„°ë„·ì´ ì•ˆë˜ëŠ” ìƒí™©
- ê·¸ëŸ¬ë¯€ë¡œ ì¸í„°ë„·ì´ ë˜ë©´ ë¬¸ì œê°€ í•´ê²° ëœë‹¤.

# 4. docker executor ì—ì„œ CI ë¹Œë“œ ì‹œì— self-signed ì—ëŸ¬

## 4.1. í˜„ìƒ

ë°°ê²½

- gitlab ruuner ì˜ docker executor ë¥¼ ì—°ê²°í•˜ê³  .gitlab-ci.yml ì„ í†µí•´ CI job ì„ ëŒë¦´ ë•Œ ì—ëŸ¬ ë°œìƒ

`.gitlab-ci.yml`

``` yml
stages:
  - build
  - test

build-job:
  stage: build
  script:
  - echo "Hello, $GITLAB_USER_LOGIN!"

test-job1:
  stage: test
  script:
  - echo "This job tests something"
  - echo $(pwd)
  - ls
```

CI job ì—ëŸ¬ ë¡œê·¸

``` bash
[0KRunning with gitlab-runner 14.2.0 (58ba2b95)[0;m
[0K  on abcd RsSnGR_s[0;m
section_start:1632378985:prepare_executor
[0K[0K[36;1mPreparing the "docker" executor[0;m[0;m
[0KUsing Docker executor with image alpine:latest ...[0;m
[0KPulling docker image alpine:latest ...[0;m
[0KUsing docker image sha256:bb3de5531c18f185667b0be0e400ab24aa40f4440093de82baf4072e14af3b84 for alpine:latest with digest alpine@sha256:e1c082e3d3c45cccac829840a25941e679c25d438cc8412c2fa221cf1a824e6a ...[0;m
section_end:1632378990:prepare_executor
[0Ksection_start:1632378990:prepare_script
[0K[0K[36;1mPreparing environment[0;m[0;m
Running on runner-rssngrs-project-5-concurrent-0 via 7a946a7957b5...
section_end:1632378991:prepare_script
[0Ksection_start:1632378991:get_sources
[0K[0K[36;1mGetting source from Git repository[0;m[0;m
[32;1mFetching changes with git depth set to 50...[0;m
Reinitialized existing Git repository in /builds/root/3path-ci-test/.git/
fatal: unable to access 'https://gitlab.bellship.com/root/3path-ci-test.git/': OpenSSL SSL_connect: SSL_ERROR_SYSCALL in connection to gitlab.bellship.com:443 
section_end:1632378993:get_sources
[0Ksection_start:1632378993:cleanup_file_variables
[0K[0K[36;1mCleaning up file based variables[0;m[0;m
section_end:1632378994:cleanup_file_variables
[0K[31;1mERROR: Job failed: exit code 1[0;m
```

- SSL_connect ì´ìŠˆê°€ ìˆì–´ë³´ì¸ë‹¤.

## 4.2. ë¶„ì„

gitlab ì˜ self-signed ì¸ì¦ì„œì— ëŒ€í•œ ca.crt ì°¸ê³  ë¶ˆê°€ ì˜ˆìƒ

- gitlab ì„ self-signed ì¸ì¦ì„œë¥¼ ì‚¬ìš©í–ˆë‹¤.
- gitlab runner ë¥¼ ë“±ë¡í•  ë•Œ, gitlab ì˜ ca.crt ë¥¼ ì˜µì…˜ì— ì¶”ê°€í•´ì¤˜ì„œ ì •ìƒì ìœ¼ë¡œ ë“±ë¡í•  ìˆ˜ ìˆì—ˆë‹¤.
- ê·¸ëŸ°ë°, gitlab runner docker executor ì— ì˜í•´ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆê°€ gitlab ì£¼ì†Œì— ëŒ€í•œ ca.crt ë¥¼ ì°¸ê³ í•˜ì§€ ëª»í•˜ëŠ” ê²ƒ ê°™ë‹¤.

## 4.3. í•´ê²°

### config.toml ì— pre_clone_script ì„¤ì •

- /etc/hosts ì— gitlab ì„œë²„ì— ëŒ€í•œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ë©´ ëœë‹¤.ã…ˆ

ì°¸ê³ 

- [[gitlab docs] Trusting TLS certificates for Docker and Kubernetes executors](https://docs.gitlab.com/runner/configuration/tls-self-signed.html#trusting-tls-certificates-for-docker-and-kubernetes-executors)

### 4.3.1. (â–³) docker network ë¥¼ host ë¡œ ì„¤ì •

gitlab runner ì˜ `config.toml` ì—ì„œ job ì˜ docker network ë¥¼ host ë¡œ ì„¤ì •

`config.toml` ì— ì•„ë˜ ë‚´ìš© ì¶”ê°€

``` toml
[[runners]]
  [runners.docker]
    network_mode = "host"
```

ì„¤ì • í›„ ìë™ìœ¼ë¡œ runner ì»¨í…Œì´ë„ˆê°€ reload ëœ ê²ƒ í™•ì¸

``` bash
Configuration loaded                                builds=0
```

ì‹¤íŒ¨í–ˆë˜ `.gitlab-ci.yml` ì¬ì‹œë„í•˜ì—¬ ì •ìƒ ë¡œê·¸ í™•ì¸

``` bash
[0KRunning with gitlab-runner 14.2.0 (58ba2b95)[0;m
[0K  on abcd RsSnGR_s[0;m
section_start:1632380005:prepare_executor
[0K[0K[36;1mPreparing the "docker" executor[0;m[0;m
[0KUsing Docker executor with image alpine:latest ...[0;m
[0KPulling docker image alpine:latest ...[0;m
[0KUsing docker image sha256:bb3de5531c18f185667b0be0e400ab24aa40f4440093de82baf4072e14af3b84 for alpine:latest with digest alpine@sha256:e1c082e3d3c45cccac829840a25941e679c25d438cc8412c2fa221cf1a824e6a ...[0;m
section_end:1632380011:prepare_executor
[0Ksection_start:1632380011:prepare_script
[0K[0K[36;1mPreparing environment[0;m[0;m
Running on runner-rssngrs-project-5-concurrent-0 via 7a946a7957b5...
section_end:1632380011:prepare_script
[0Ksection_start:1632380011:get_sources
[0K[0K[36;1mGetting source from Git repository[0;m[0;m
[32;1mFetching changes with git depth set to 50...[0;m
Reinitialized existing Git repository in /builds/root/3path-ci-test/.git/
[32;1mChecking out 3aba8370 as master...[0;m

[32;1mSkipping Git submodules setup[0;m
section_end:1632380012:get_sources
[0Ksection_start:1632380012:step_script
[0K[0K[36;1mExecuting "step_script" stage of the job script[0;m[0;m
[0KUsing docker image sha256:bb3de5531c18f185667b0be0e400ab24aa40f4440093de82baf4072e14af3b84 for alpine:latest with digest alpine@sha256:e1c082e3d3c45cccac829840a25941e679c25d438cc8412c2fa221cf1a824e6a ...[0;m
[32;1m$ echo "Hello, $GITLAB_USER_LOGIN!"[0;m
Hello, root!
section_end:1632380013:step_script
[0Ksection_start:1632380013:cleanup_file_variables
[0K[0K[36;1mCleaning up file based variables[0;m[0;m
section_end:1632380013:cleanup_file_variables
[0K[32;1mJob succeeded[0;m
```
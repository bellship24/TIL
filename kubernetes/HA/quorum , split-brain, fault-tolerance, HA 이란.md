**목차**

- [1. quorum 이란?](#1-quorum-이란)
- [2. split brain 이란?](#2-split-brain-이란)
- [3. fault tolerance 란?](#3-fault-tolerance-란)
- [4. High Availability 란?](#4-high-availability-란)
- [5. fault tolerance 와 high availability 비교](#5-fault-tolerance-와-high-availability-비교)
- [6. k8s 클러스터 사이즈와 quorum, fault tolerance 의 관계](#6-k8s-클러스터-사이즈와-quorum-fault-tolerance-의-관계)

**참고**

- [클러스터 멤버가 홀수여야 하는 이유, failure(fault) tolerance란(etcd FAQ)](https://etcd.io/docs/v3.2/faq/#etcd-general)
- [quorum 이란?](http://www.mantech.co.kr/quorum/)
- [fault tolerance 란?](https://www.imperva.com/learn/availability/fault-tolerance/)
- [high availability 란?](https://velog.io/@makeitcloud/란-Availability-High-Availability-란)
- [Setting up highly available Kubernetes clusters](https://elastisys.com/wp-content/uploads/2018/01/kubernetes-ha-setup.pdf)

# 1. quorum 이란?

- quorum, 쿼럼, 정족수.
- = majority.
- 사전적 의미로는 `합의체가 의사를 진행시키거나 의결을 하는데 필요한 최소한도의 인원수`.
- 쉽게 말해, 어떤 일에 대한 의사결정을 투표로 진행하기 위한 최소 과반수.
- 예를 들어, n 구성원이 있는 클러스터의 경우 쿼럼은 `(n / 2)+1` 의 정수 부분이다.

# 2. split brain 이란?

- 클러스터로 구성된 시스템에서 network partition(네트워크 단절) 등의 이유로 모든 노드들이 각자 자신이 primary 혹은 master 라고 인식하고 연결이 끊긴 노드들은 죽었다고 인식하는 상황. 이로 인해 이중 구동 장애 같은 클러스터에 장애가 발생할 수 있다. 즉, 각각 데이터 업데이트가 이뤄지다가 네트워크가 복구됐을 때 데이터 비동기 등의 문제가 발생할 수 있다.
- split brain 을 예방하기 위해서는 quorum 구조를 사용한다. 예를 들어, etcd 클러스터는 네트워크 파티션이 발생했을 때 두 그룹으로 나뉜다. 하나는 majority member, 다른 하나는 minority member 이다. majority 는 사용 가능한 클러스터가 되고 minority 쪽은 사용할 수 없게 된다. 즉, etcd 에는 splitbrain 이 없다. 리더가 majority 쪽에 있다면 majority 의 관점에서 실패는 **minority follower failure** 이다. 리더가 minority 쪽에 있으면 **leader failure** 이 된다. 즉, minority 측의 리더가 물러나고 majority 측이 새로운 리더를 선출한다.

# 3. fault tolerance 란?

- fault tolerance. failure tolerance. 내결함성
- 내결함성은 시스템(컴퓨터, 네트워크, 클라우드 클러스터 등)이 하나 이상의 구성 요소에 장애가 발생해도 중단없이 계속 작동할 수 있는 능력을 나타낸다.
- 내결함성 시스템의 목표는 single point of failure(단일 장애 지점) 에서 발생하는 중단을 방지하여 미션 크리티컬 애플리케이션 또는 시스템의 고 가용성 및 비즈니스 연속성을 보장하는 것다.
- 내결함성 시스템은 고장난 구성 요소를 자동으로 대체하는 백업 구성 요소를 사용하여 서비스 손실을 방지한다. 여기에는 아래 것들이 포함된다.
  - 동일하거나 동등한 시스템에 의해 백업되는 **하드웨어 시스템**. 예를 들어, 모든 작업이 백업 서버에 미러링 된 상태에서 병렬로 실행되는 동일한 서버를 사용하여 서버를 내결함성으로 만들 수 있다.
  - 다른 소프트웨어 인스턴스에 의해 백업되는 **소프트웨어 시스템**. 예를 들어, 고객 정보가 포함 된 데이터베이스를 다른 시스템에 지속적으로 복제 할 수 있다. 기본 데이터베이스가 다운되면 작업이 자동으로 두 번째 데이터베이스로 리디렉션 될 수 있다.
  - 대체 소스를 사용하여 내결함성이있는 **power source(전원)**입니다. 예를 들어, 많은 데이터 센터는 주선 전기가 중단 될 경우 대신 할 수있는 발전기를 보유하고 있습니다.

# 4. High Availability 란?

- Availability, 가용성이란 서버와 네트워크, 프로그램 등의 정보 시스템이 정상적으로 사용 가능한 정도를 말한다.
- Availability = Uptime / ( Uptime + Downtime )
- 정보기술에서, HA란 바람직한 정도로 긴 시간동안 지속적으로 운영이 가능한 시스템이나 컴포넌트를 가리킨다. 가용성이란 흔히 "100% 가용" 등과 같이 상대적으로 측정되거나 또는 "절대 고장나지 않음" 등과 같이 표현될 수 있다. 널리 쓰이고 있지만 달성하기 결코 쉽지 않은 시스템 및 제품에 대한 가용성 표준에 흔히 "파이브 나인" (five 9) 이라고 부르는 99.999%의 가용성을 들 수 있다. 하나의 컴퓨터 시스템이나 네트웍은 전체의 운영을 위해 모두가 사용 가능한 상태로 있어야만 하는 가능한 수많은 부품으로 구성되었기 때문에, 고 가용성에 대한 많은 계획들이 백업이나 장애극복 처리 및 데이터 저장 및 액세스 등에 집중되어 있다.

HA의 목적은 서비스의 다운타임을 최소화함으로써 가용성을 극대화하자는 것이다. 운영 서버에 장애가 발생하더라도, 대기 서버가 즉시 서비스를 대신 처리해 준다면 서비스의 다운타임은 최소화될 수 있다. HA와 클러스터(Cluster)라는 용어는 엄밀히 말하면 다르지만, 고가용성이라는 의미로 혼용해 사용하고 있다.

# 5. fault tolerance 와 high availability 비교

- 예를 들어, 트윈 엔진 비행기는 내결함성 시스템이다. 한 엔진이 고장 나면 다른 엔진이 작동하여 비행기가 계속 비행 할 수 있다. 반대로 스페어 타이어가 있는 자동차는 가용성이 높다. 펑크 난 타이어는 차를 멈추게하지만 타이어를 쉽게 교체 할 수 있기 때문에 가동 중단 시간이 최소화 된다.
- 내결함성 및 고 가용성 시스템을 만들 때 고려해야 할 몇 가지 중요한 사항은 다음과 같다.
  - Downtime : 고 가용성 시스템은 최소한의 서비스 중단 수준을 허용한다. 예를 들어, 가용성이 "five nines"(파이브 나인. 가용성의 표준 목표 99.999%) 인 시스템은 연간 약 5 분 동안 다운된다. 내결함성 시스템은 수용 가능한 서비스 중단없이 지속적으로 작동 할 것으로 기대된다.
  - Scope : 고 가용성은 장애를 관리하고 다운 타임을 최소화하기 위해 공동으로 사용되는 공유 리소스 세트를 기반으로 한다. 내결함성은 전원 공급 장치 백업뿐만 아니라 장애를 감지하고 즉시 중복 구성 요소로 전환할 수 있는 하드웨어 또는 소프트웨어에 의존한다.
  - Cost : 내결함성 시스템은 추가의 중복 구성 요소를 지속적으로 운영하고 유지 관리해야하므로 비용이 많이들 수 있다. 고 가용성은 일반적으로 서비스 공급자 (예 :로드 밸런서 공급자)를 통해 전체 패키지의 일부로 제공된다.
- 일부 시스템은 내결함성 설계가 필요할 수 있지만 고 가용성으로 충분할 수 있다. 서비스 중단에 대한 각 시스템의 허용 오차, 이러한 중단 비용, 서비스 제공 업체 및 고객과의 기존 SLA 계약, 전체 내결함성을 구현하는 데 드는 비용 및 복잡성을 고려해야한다.

# 6. k8s 클러스터 사이즈와 quorum, fault tolerance 의 관계

| Cluster Size | Majority | Failure Tolerance |
|--------------|----------|-------------------|
| 1            | 1        | 0                 |
| 2            | 2        | 0                 |
| 3            | 2        | 1                 |
| 4            | 3        | 1                 |
| 5            | 3        | 2                 |
| 6            | 4        | 2                 |
| 7            | 4        | 3                 |
| 8            | 5        | 3                 |
| 9            | 5        | 4                 |
